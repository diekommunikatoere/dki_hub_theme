name: Release Build

permissions:
    contents: write

on:
    workflow_dispatch:
        inputs:
            release_tag:
                description: "Release tag (e.g., v1.0.0)"
                required: true
                type: string
            create_github_release:
                description: "Create GitHub Release"
                required: false
                type: boolean
                default: false

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0
                  persist-credentials: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: "blocks/*/package.json"

            - name: Make release script executable
              run: chmod +x scripts/release-build.sh

            - name: Publish release branch
                # Ensure clean workspace before switching branches
                git reset --hard
              run: |
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  RELEASE_BRANCH="release"
                  if git rev-parse --verify origin/$RELEASE_BRANCH >/dev/null 2>&1; then
                    git fetch origin $RELEASE_BRANCH:$RELEASE_BRANCH
                    git checkout $RELEASE_BRANCH
                  else
                    git checkout --orphan $RELEASE_BRANCH
                  fi

                  git rm -rf . || true
                  cp -r release/. .

                  git add .
                  git commit -m "Release: ${{ inputs.release_tag }} [ci skip]" || echo "No changes to commit"
                  git push origin $RELEASE_BRANCH --force
            - name: Run release build
              run: ./scripts/release-build.sh
              env:
                  RELEASE_TAG: ${{ inputs.release_tag }}

            - name: Run smoke tests
              run: |
                  echo "Running smoke tests..."
                  # Check that release directory was created
                  if [ ! -d "release" ]; then
                    echo "❌ Release directory not found"
                    exit 1
                  fi

                  # Check each block has expected artifacts
                  for block_dir in blocks/*/; do
                    if [ -f "$block_dir/package.json" ]; then
                      block_name=$(basename "$block_dir")
                      echo "Checking block: $block_name"
                      
                      # Check block directory exists in release
                      if [ ! -d "release/$block_name" ]; then
                        echo "❌ Block $block_name not found in release"
                        exit 1
                      fi
                      
                      # Check for built assets (build/ or dist/)
                      if [ ! -d "release/$block_name/build" ] && [ ! -d "release/$block_name/dist" ]; then
                        echo "❌ Block $block_name missing built assets (build/ or dist/)"
                        exit 1
                      fi
                      
                      # Check for PHP files
                      if ! find "release/$block_name" -name "*.php" | grep -q .; then
                        echo "❌ Block $block_name missing PHP files"
                        exit 1
                      fi
                      
                      echo "✅ Block $block_name validated"
                    fi
                  done

                  # Check theme files
                  if [ ! -f "release/functions.php" ]; then
                    echo "❌ Missing functions.php in release"
                    exit 1
                  fi

                  if [ ! -d "release/includes/css" ]; then
                    echo "❌ Missing compiled CSS in release"
                    exit 1
                  fi

                  if [ ! -d "release/fonts" ]; then
                    echo "❌ Missing fonts in release"
                    exit 1
                  fi

                  echo "✅ All smoke tests passed"

            - name: Push expanded release contents to release branch
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git fetch --all
                  if git ls-remote --exit-code origin release; then
                    git checkout -B release origin/release
                  else
                    git checkout --orphan release
                  fi
                  git rm -rf .
                  cp -r release/* .
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add .
                  git commit -m "Release: ${{ inputs.release_tag }} [ci skip]" || echo "No changes to commit"
                  git push origin release --force
