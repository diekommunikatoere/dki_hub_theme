name: Release Build

permissions:
    contents: write

on:
    workflow_dispatch:
        inputs:
            release_tag:
                description: "Release tag (e.g., v1.0.0)"
                required: true
                type: string
            force_rebuild_all:
                description: "Force rebuild all blocks (ignore change detection)"
                required: false
                type: boolean
                default: false
            verbose:
                description: "Enable detailed logging"
                required: false
                type: boolean
                default: true
            parallel:
                description: "Enable parallel block building"
                required: false
                type: boolean
                default: true

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0
                  persist-credentials: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: "blocks/*/package.json"

            - name: Cache block dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      blocks/*/node_modules
                      ~/.npm
                  key: blocks-${{ hashFiles('blocks/*/package-lock.json') }}
                  restore-keys: |
                      blocks-

            # Phase 2: Build artifact caching
            - name: Cache block build artifacts
              uses: actions/cache@v4
              with:
                  path: blocks/*/build
                  key: build-artifacts-${{ hashFiles('blocks/*/src/**/*', 'blocks/*/package.json') }}
                  restore-keys: |
                      build-artifacts-
                      build-

            - name: Detect changed blocks
              id: detect_changes
              run: |
                  LAST_TAG="${{ inputs.release_tag }}"
                  CHANGED_FILES=$(git diff --name-only $LAST_TAG HEAD | grep "^blocks/" || true)
                  CHANGED_BLOCKS=$(echo "$CHANGED_FILES" | awk -F/ '{print $2}' | sort | uniq | xargs)
                  echo "changed_blocks=$CHANGED_BLOCKS" >> $GITHUB_OUTPUT
                  echo "$CHANGED_FILES" > changed_files.txt

            - name: Make release script executable
              run: chmod +x scripts/release-build.sh

            - name: Run release build
              run: |
                  BUILD_FLAGS=""
                  if [ "${{ inputs.verbose }}" = "true" ]; then
                    BUILD_FLAGS="$BUILD_FLAGS --verbose"
                  fi
                  if [ "${{ inputs.parallel }}" = "true" ]; then
                    BUILD_FLAGS="$BUILD_FLAGS --parallel"
                  fi
                  ./scripts/release-build.sh $BUILD_FLAGS
              env:
                  RELEASE_TAG: ${{ inputs.release_tag }}
                  FORCE_REBUILD_ALL: ${{ inputs.force_rebuild_all }}
                  CHANGED_BLOCKS: ${{ steps.detect_changes.outputs.changed_blocks }}
                  CHANGED_FILES_FILE: changed_files.txt

            - name: Verify release directory
              run: |
                  if [ ! -d "release" ]; then
                    echo "❌ Release directory not found after build"
                    exit 1
                  fi
                  echo "✅ Release directory created successfully"

            - name: Publish release branch
              run: |
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  cp -r release /tmp/release-temp
                  git stash push -m "Build artifacts before release branch switch"

                  RELEASE_BRANCH="release"
                  if git rev-parse --verify origin/$RELEASE_BRANCH >/dev/null 2>&1; then
                    git fetch origin $RELEASE_BRANCH:$RELEASE_BRANCH
                    git checkout $RELEASE_BRANCH
                  else
                    git checkout --orphan $RELEASE_BRANCH
                  fi

                  git rm -rf . || true
                  cp -r /tmp/release-temp/. .
                  rm -rf /tmp/release-temp

                  git add .
                  git commit -m "Release: ${{ inputs.release_tag }} [ci skip]" || echo "No changes to commit"
                  git push origin $RELEASE_BRANCH --force

            - name: Summary
              run: |
                  echo "🎉 Release build completed successfully!"
                  echo "📦 Release tag: ${{ inputs.release_tag }}"
                  echo "🌿 Release branch: release"
                  echo "📁 Artifacts available in release branch"
